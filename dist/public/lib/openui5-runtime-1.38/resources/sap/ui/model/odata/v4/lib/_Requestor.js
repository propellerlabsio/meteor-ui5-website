/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./_Batch","./_Helper"],function(q,_,a){"use strict";var f={"Content-Type":"application/json;charset=UTF-8;IEEE754Compatible=true"},p={"Accept":"application/json;odata.metadata=minimal;IEEE754Compatible=true"},P={"Accept":"application/json;odata.metadata=minimal;IEEE754Compatible=true","OData-MaxVersion":"4.0","OData-Version":"4.0","X-CSRF-Token":"Fetch"};function g(h){var r;h=h.toLowerCase();for(r in this.headers){if(r.toLowerCase()===h){return this.headers[r];}}}function R(s,h,Q){this.mBatchQueue={};this.mHeaders=h||{};this.sQueryParams=a.buildQuery(Q);this.oSecurityTokenPromise=null;this.sServiceUrl=s;}R.prototype.getServiceUrl=function(){return this.sServiceUrl;};R.prototype.refreshSecurityToken=function(){var t=this;if(!this.oSecurityTokenPromise){this.oSecurityTokenPromise=new Promise(function(r,b){q.ajax(t.sServiceUrl+t.sQueryParams,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}).then(function(d,T,j){t.mHeaders["X-CSRF-Token"]=j.getResponseHeader("X-CSRF-Token");t.oSecurityTokenPromise=null;r();},function(j,T,e){t.oSecurityTokenPromise=null;b(a.createError(j));});});}return this.oSecurityTokenPromise;};R.prototype.request=function(m,r,G,h,o,i){var t=this,b,I=r==="$batch",s,c,d;G=G||"$direct";if(I){b=_.serializeBatchRequest(o);s=b.body;}else{s=JSON.stringify(o);if(G!=="$direct"){c=new Promise(function(e,j){var l,k=t.mBatchQueue[G];if(!k){k=t.mBatchQueue[G]=[[]];}d={method:m,url:r,headers:q.extend({},p,t.mHeaders,h,f),body:s,$reject:j,$resolve:e};if(m==="GET"){k.push(d);}else{l=k[0].length&&k[0][k[0].length-1];if(l&&l.method==="PATCH"&&d.method==="PATCH"&&l.url===d.url&&q.sap.equal(l.headers,d.headers)){l.body=JSON.stringify(q.extend(JSON.parse(l.body),o));e(l.$promise);}else{k[0].push(d);}}});d.$promise=c;return c;}}return new Promise(function(e,j){q.ajax(t.sServiceUrl+r+(I?t.sQueryParams:""),{data:s,headers:q.extend({},P,t.mHeaders,h,I?b.headers:f),method:m}).then(function(o,T,k){t.mHeaders["X-CSRF-Token"]=k.getResponseHeader("X-CSRF-Token")||t.mHeaders["X-CSRF-Token"];if(I){o=_.deserializeBatchResponse(k.getResponseHeader("Content-Type"),o);}e(o);},function(k,T,E){var C=k.getResponseHeader("X-CSRF-Token");if(!i&&k.status===403&&C&&C.toLowerCase()==="required"){t.refreshSecurityToken().then(function(){e(t.request(m,r,G,h,o,true));},j);}else{j(a.createError(k));}});});};R.prototype.submitBatch=function(G){var r=this.mBatchQueue[G];function v(r,b){var c;r.forEach(function(d,i){var e,h=b[i];if(Array.isArray(d)){v(d,h);}else if(h){if(h.status>=400){h.getResponseHeader=g;c=a.createError(h);d.$reject(c);}else{d.$resolve(JSON.parse(h.responseText));}}else{e=new Error("HTTP request was not processed because the previous request failed");e.cause=c;d.$reject(e);}});}if(!r){return Promise.resolve();}delete this.mBatchQueue[G];if(r[0].length===0){r.splice(0,1);}else if(r[0].length===1){r[0]=r[0][0];}return this.request("POST","$batch",undefined,undefined,r).then(v.bind(null,r)).catch(function(e){var o=new Error("HTTP request was not processed because $batch failed");function b(r){r.forEach(function(c){if(Array.isArray(c)){b(c);}else{c.$reject(o);}});}o.cause=e;b(r);throw e;});};return{create:function(s,h,Q){return new R(s,h,Q);}};},false);
