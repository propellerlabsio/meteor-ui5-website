/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/Binding","sap/ui/model/ChangeReason","sap/ui/model/ListBinding","./_Context","./_ODataHelper","./lib/_Cache"],function(q,B,C,L,_,a,b){"use strict";var c="sap.ui.model.odata.v4.ODataListBinding",s={change:true,dataReceived:true,dataRequested:true,refresh:true};var O=L.extend("sap.ui.model.odata.v4.ODataListBinding",{constructor:function(m,p,o,P){var d;L.call(this,m,p,o);if(!p||p.slice(-1)==="/"){throw new Error("Invalid path: "+p);}this.oCache=undefined;this.sGroupId=undefined;this.sRefreshGroupId=undefined;this.sUpdateGroupId=undefined;if(!this.bRelative){this.oCache=b.create(m.oRequestor,p.slice(1),a.buildQueryOptions(m.mUriParameters,P,["$expand","$filter","$orderby","$select"]));d=a.buildBindingParameters(P);this.sGroupId=d.$$groupId;this.sUpdateGroupId=d.$$updateGroupId;}else if(P){throw new Error("Bindings with a relative path do not support parameters");}this.aContexts=[];this.iMaxLength=Infinity;this.bLengthFinal=false;}});O.prototype.attachEvent=function(e){if(!(e in s)){throw new Error("Unsupported event '"+e+"': v4.ODataListBinding#attachEvent");}return L.prototype.attachEvent.apply(this,arguments);};O.prototype.filter=function(){throw new Error("Unsupported operation: v4.ODataListBinding#filter");};O.prototype.getContexts=function(S,l,t){var o=this.oContext,d=false,g,m=this.oModel,p,r=m.resolve(this.sPath,o),e=this;function f(){var i,n=S+l;for(i=S;i<n;i+=1){if(e.aContexts[i]===undefined){return false;}}return true;}function h(R){var j=false,i,N,k=Array.isArray(R)?R.length:R.value.length,n=S+k;for(i=S;i<n;i+=1){if(e.aContexts[i]===undefined){j=true;e.aContexts[i]=_.create(m,e,r+"/"+i,i);}}if(e.aContexts.length>e.iMaxLength){e.iMaxLength=Infinity;}if(k<l){e.iMaxLength=Math.min(S+k,e.iMaxLength);if(e.aContexts.length>e.iMaxLength){e.aContexts.splice(e.iMaxLength,e.aContexts.length-e.iMaxLength);}}N=e.aContexts.length===e.iMaxLength;if(e.bLengthFinal!==N){e.bLengthFinal=N;j=true;}if(j){e._fireChange({reason:C.Change});}}if(t!==undefined){throw new Error("Unsupported operation: v4.ODataListBinding#getContexts, "+"iThreshold parameter must not be set");}S=S||0;l=l||m.iSizeLimit;if(!r){return[];}if(!f(S,l)){if(this.oCache){g=this.sRefreshGroupId||this.getGroupId();this.sRefreshGroupId=undefined;p=this.oCache.read(S,l,g,undefined,function(){d=true;e.oModel.addedRequestToGroup(g,e.fireDataRequested.bind(e));});}else{p=o.requestValue(this.sPath);}p.then(function(R){h(R||[]);if(d){e.fireDataReceived();}},function(E){if(d){if(E.canceled){e.fireDataReceived();}else{m.reportError("Failed to get contexts for "+m.sServiceUrl+r.slice(1)+" with start index "+S+" and length "+l,c,E);e.fireDataReceived({error:E});}}})["catch"](function(E){q.sap.log.error(E.message,E.stack,c);});}return this.aContexts.slice(S,S+l);};O.prototype.getCurrentContexts=function(){throw new Error("Unsupported operation: v4.ODataListBinding#getCurrentContexts");};O.prototype.getDistinctValues=function(){throw new Error("Unsupported operation: v4.ODataListBinding#getDistinctValues");};O.prototype.getGroupId=function(){return this.sGroupId||this.oModel.getGroupId();};O.prototype.getLength=function(){return this.bLengthFinal?this.aContexts.length:this.aContexts.length+10;};O.prototype.getUpdateGroupId=function(){return this.sUpdateGroupId||this.oModel.getUpdateGroupId();};O.prototype.initialize=function(){if(this.oModel.resolve(this.sPath,this.oContext)){this._fireChange({reason:C.Change});}};O.prototype.isInitial=function(){throw new Error("Unsupported operation: v4.ODataListBinding#isInitial");};O.prototype.isLengthFinal=function(){return this.bLengthFinal;};O.prototype.refresh=function(g){if(!this.oCache){throw new Error("Refresh on this binding is not supported");}a.checkGroupId(g);this.sRefreshGroupId=g;this.oCache.refresh();this.aContexts=[];this.iMaxLength=Infinity;this.bLengthFinal=false;this._fireRefresh({reason:C.Refresh});};O.prototype.requestValue=function(p,i){return this.oCache?this.oCache.read(i,1,undefined,p):this.oContext.requestValue(this.sPath+"/"+i+(p?"/"+p:""));};O.prototype.resume=function(){throw new Error("Unsupported operation: v4.ODataListBinding#resume");};O.prototype.setContext=function(o){if(this.oContext!==o){if(this.bRelative){this.aContexts=[];B.prototype.setContext.call(this,o);}else{this.oContext=o;}}};O.prototype.sort=function(){throw new Error("Unsupported operation: v4.ODataListBinding#sort");};O.prototype.suspend=function(){throw new Error("Unsupported operation: v4.ODataListBinding#suspend");};O.prototype.toString=function(){return c+": "+(this.bRelative?this.oContext+"|":"")+this.sPath;};O.prototype.updateValue=function(g,p,v,e,P){var o;if(this.oCache){g=g||this.getUpdateGroupId();o=this.oCache.update(g,p,v,e,P);this.oModel.addedRequestToGroup(g);return o;}return this.oContext.updateValue(g,p,v,e,this.sPath+"/"+P);};return O;},true);
